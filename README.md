# RNA Helix Classifier

## Introduction

This project implements a classifier to distinguish between RNA helices that are present in the secondary structure and those that are not (Present vs Absent). Feature categories include SHAPE (Selective 2'-Hydroxy Acylation analyzed by Primer Extension), relative helix locations and distances, nucleotide content, and thermodynamic-driven features such as MEL (Motif Energy Loss) and ProbScan probabilities. The pipeline currently covers data extraction, metric calculation, feature engineering and visualization, feature automation, model comparisons, and final model training.

## Requirements

- **Python Version**: Python 3.x
- **Libraries**:
  - `numpy`
  - `pandas`
  - `matplotlib`
  - `seaborn`
  - `scikit-learn`
  - `subprocess`
  - `ast`

## Important Information

- Only internal helices are studied (stem size and base numbers exclude the bases at the ends of the helix).
- The most studied and best-performing models are based on logistic regression, with a separate model trained for each helix stem size.
- SHAPE reactivities are generally higher for absent helices and lower for present helices (base-paired helices are typically less reactive).
- Putative helices are those potentially present based on base pair interactions. Present helices are verified to exist in the secondary structure, while absent helices are putative helices not verified to be present. The goal is to predict whether an unseen helix is actually present in the secondary structure.

## Pipeline Details by Folder 

### All_Helices_Data

#### Datasets Involved

There are currently a few RNA datasets involved: Weeks, CRW2, and 16S rRNA.

- **Weeks Dataset**: Well-studied and contains empirically determined SHAPE data.
    - Extraction is performed using the `Weeks_Set_Extraction` folder.
- **CRW2 and 16S rRNA Datasets**: Do not have empirically determined SHAPE data.
    - SHAPE values for these datasets are simulated using probability distributions from the Weeks set.
    - The extraction pipeline for this data can be found in `Simulated_Helices_Extraction`.

#### Data Files Overview

The following file types are used throughout the pipeline. 

- **.ct Reference Files**: Contain RNA secondary structure information in connect table format, specifying base pairing for each nucleotide.
- **FASTA Files**: Store the raw RNA nucleotide sequences.
- **SHAPE Files**:
    - *For Empirically Determined (Weeks)*: Provide experimentally measured SHAPE reactivity values for each nucleotide.
    - *Simulated (Not Weeks)*: Contain SHAPE reactivity values generated by sampling from probability distributions; multiple files represent different simulation samples.
- **Putative Helices Files**: List potential helices by their indices (i, j, k, l), where external helix ends are ordered as i, k, l, j. The internal helices & metadata must be processed to match the format found in the **Real Helix Files**
- **Real Helices Files**: Specify verified helices in the format: `RNA | Base Pair Category | Nucleotides`.
- **Thermodynamics Data Files**: Include files foundational to calculating motif energy loss (MEL) and ProbScan values

### Weeks_Set_Extraction

- **create_putative_exclusive_v2_PT.py**  
  Identifies and writes helices that are present in the putative set but absent from the real helices set. 
  **Important:** This needs be updated to interface with the updated formatting (i-j-k-l) of the putative helices

- **extractdata_v2_PT.py**  
  Extracts SHAPE reactivity values for each helix from the Weeks dataset and writes them to output files for absent and present helices.

- **calculate_metrics_v2.py**  
  Calculates statistical metrics (mean, median, stdev, etc.) for each helix based on its SHAPE reactivity values and outputs a consolidated CSV.

### Early_Logistic_Regression_Experiments

- **analyze_and_plot_helix_reactivities_PT_v2.py**  
  Analyzes and visualizes SHAPE reactivity distributions for putative and real helices using histograms, boxplots, and bar charts.

- **Combined_LR_Classifier_v2.py**  
   Implements a flexible logistic regression classifier with options for feature selection, scaling, sampling, and detailed model evaluation including ROC/PR curves. This also includes the logging of parameters and results to a CSV file.

- **log_regression_barebones.py**  
  Minimal logistic regression pipeline for initial testing, including basic feature selection, model training, and confusion matrix visualization.

- **LR_automated_all_combos.py**  
  Automates logistic regression training and evaluation for all possible feature combinations, outputting performance metrics for each. Note that this experiment was only performed with the initial SHAPE-directed metrics. 

- **Order_Features_F1.py**  
  Consolidates and sorts the results from multiple feature combination CSVs, ranking them by F1-score.

- **visualize.py**  
  Generates 2D and 3D scatter plots for selected feature combinations to visualize separability between present and absent helices. 

### Simulated_Helices_Extraction

- **extract_putative_simulated_v1_NT.py.ipynb**  
  Initial version of Python notebook for extracting and processing putative simulated helices, including expansion of helix ends and base pair counting.

- **extract_putative_simulated_v2_PT.py.py**  
  Final script for extracting, expanding, and categorizing putative simulated helices from input files, saving results in a tab-separated format.

- **create_absent_simulated.py**  
  Identifies and writes simulated helices that are present in the putative set but absent from the real helices set.

- **extract_simulated_SHAPE.py**  
  Extracts the desired number of samples of simulated SHAPE data for the present and absent helices, appending the SHAPE data to the existing metadata to create new output files. 

- **calculate_metrics_simulated_helices.py**  
  Computes statistical metrics (mean, median, stdev, etc.) for simulated helices using their SHAPE reactivity data and outputs a consolidated CSV for all present and absent helices with simulated SHAPE data.

  - **Combine_and_Split_Metrics_by_Stem_Size_v2_PT.py.py**  
  Combines real and simulated helix metrics, then splits and saves them into separate CSV files by stem size, also logging counts.

- **add_sequence_and_relative_positions.py**  
  Adds the nucleotide sequence and relative nucleotide positions to each helix entry in the metrics CSVs, using sequence data from FASTA files.

- **add_RNA_lengths.py**  
  Calculates and adds the RNA sequence length for each helix entry in the metrics CSVs, based on corresponding FASTA files.

### Logistic_Regression_Experimentation_by_Stem_Size

- **LR_Classifier_by_Stem_Size.py**  
  Trains and evaluates a logistic regression model for a specific stem size, with options for feature selection, scaling, sampling, and detailed performance analysis. Logs results to a CSV.

- **LR_Automate_by_Stem_Size.py**  
  Automates logistic regression training and evaluation for all possible feature combinations and stem sizes, outputting ranked CSVs for each stem size.

- **Automated_Combined_LR.py**  
  Runs logistic regression experiments for all parameter combinations specified in a CSV, supporting flexible feature selection, scaling, and sampling. Logs results for each run.

- **generate_all_feature_combos.py**  
  Generates all possible parameter combinations (feature sets, scaling, thresholds, etc.) and saves them to a CSV for use in automated model runs.

- **model_Classifier(diagnostics_only)_NT.py.py**  
  Generates diagnostic samples and performance metrics from model predictions, including random and diagnostic (FP/FN) samples, and saves them for further analysis.

- **stem_size_{stem_size}_LR_classifier.ipynb**  
  Only there as records of the feature exploration & engineering that was done to help arrive at the current best peforming models. 

### Final_Models

- **Final_Model_Executor_Modularized.py**  
  Loads processed helix metrics, engineers additional features (e.g., GC content, relative positions), trains and evaluates a logistic regression model, and visualizes performance metrics and classification results.

- **Final_Model_Executor_Modularized_Thermo.py**  
  Similar to the above, but also incorporates thermodynamic features (e.g., ProbScan, ProbScan Shape, ProbScan Difference) into the feature set for model training and evaluation. Also prints sorted logistic regression coefficients.

### Thermodynamic Features 
This directory contains two subfolders and one script file related to the analysis of RNA thermodynamic features. The script file, `Transpose Shape.py`, can be used to correct the format of SHAPE data files that are provided in paragraph format—specifically for files from the Weeks dataset—by transposing the data into a columnar format suitable for input into other functions in the RNAstructure software suite.

- **Transpose Shape.py**  
  This script transposes SHAPE (Selective 2′-Hydroxyl Acylation analyzed by Primer Extension) reactivity data files for a set of RNA molecules. Each input file is read, and its numeric content is transposed (rows become columns and vice versa) and saved as a new file with a `(T)` prefix. The script uses NumPy for transposition and processes a predefined list of `.shape` files. This tool is useful for reformatting SHAPE data for compatibility with downstream analysis pipelines, including those in RNAstructure.

- **MEL (Motif Energy Loss)**  
  This folder contains scripts and data related to calculating motif energy loss for a helix. A readme file titled `mel_readme.md` is provided inside this folder for instructions on how to run the pipeline.

- **ProbScan**  
  This folder contains a three-stage pipeline for analyzing RNA helix stability using ProbScan with and without SHAPE reactivity data. The pipeline processes RNA sequences, computes partition functions, evaluates helix probabilities, and integrates those into annotated CSVs for further analysis. A readme file titled `probscan_readme.md` is provided inside this folder for instructions on how to run the pipeline.
  
## Future Improvements
- Streamline the pipeline for extracting features from raw RNA data files (FASTA, SHAPE if available, putative/absent/present helices).
- Add more RNA datasets.
- Explore different models, especially nonlinear ones.
- Improve documentation where possible.
